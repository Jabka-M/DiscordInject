(async()=>{const e=require("asar"),o=require("fs"),s=require("path"),r=require("fs-extra"),i=require("util"),c=i.promisify(o.readFile),t=i.promisify(o.writeFile),n=/app\-[\w\.]+/gi,a=/discord_desktop_core\-\d/gi,l=`${process.env.LOCALAPPDATA}\\Discord\\`,d=(require("child_process").execFile,"./tmp/app/mainScreen.js");let p;await o.access(l,o.constants.F_OK,e=>{e&&(console.error(`Discord does not exists in ${l}`),process.exit(1))});let w=o.readdirSync(`${process.env.LOCALAPPDATA}\\Discord\\`).filter(e=>n.exec(e));w.length||(console.error(`App folder does not exists in ${process.env.LOCALAPPDATA}\\Discord\\`),process.exit(1)),w=s.resolve(l,w[0]),await o.access(w,o.constants.F_OK,e=>{e&&(console.error(`${w} does not exists`),process.exit(1))});let m=s.resolve(w,"modules");p=s.resolve(w,"Discord.exe"),await o.access(m,o.constants.F_OK,e=>{e&&(console.error(`${m} does not exists`),process.exit(1))});let g=o.readdirSync(m).filter(e=>a.exec(e));g.length||(console.error(`Desktop core folder does not exists in ${m}`),process.exit(1)),g=s.resolve(m,g[0],"discord_desktop_core"),await o.access(g,o.constants.F_OK,e=>{e&&(console.error(`${g} does not exists`),process.exit(1))});let x=s.resolve(g,"core.asar");await o.access(x,o.constants.F_OK,e=>{e&&(console.error(`${x} does not exists`),process.exit(1))}),console.log("Unpacking discord core..."),await r.remove("./tmp"),await i.promisify(o.copyFile)(x,"./core.asar"),await i.promisify(o.copyFile)(x,"./core.asar.backup"),e.extractAll("./core.asar","./tmp"),await i.promisify(o.copyFile)(d,`${d}.backup`);let u=await c("./code.js");u=`mainWindow.webContents.on('dom-ready', () => {setTimeout(() => {mainWindow.webContents.executeJavaScript(\`${u}\`);}, 3000);});\nmainWindow.webContents.`,console.log("Checking...");let f=await c(d,"utf-8");f.includes("mainWindow.webContents.on('dom-ready', () => {")&&(console.error("Already Injected"),process.exit(1));let y=f.replace("mainWindow.webContents.",u);console.log("Injecting..."),await t(d,y),console.log("Building new core..."),e.createPackage("./tmp","./core.asar",e=>{e&&(console.error("Failed building core"),process.exit(1))}),require("find-process")("name","Discord",!0).then(e=>{if(e.length){console.log("Killing discord...");for(let o of e)process.kill(o.pid)}}),setTimeout(async()=>{console.log("Removing original core..."),await r.remove(x),console.log("Setting up new core..."),await i.promisify(o.copyFile)("./core.asar",x),console.log("Cleaning up..."),await r.remove("./core.asar"),await r.remove("./tmp"),console.log("Success")},5e3)})();